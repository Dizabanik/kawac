name: Kawa Compiler Tests

on:
  push:
    branches: ["*"]
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    name: "Build & Test Compiler"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y make

      - name: Build compiler (make)
        run: |
          echo "::group::ðŸš§ Building compiler"
          make
          echo "::endgroup::"

      - name: Run tests
        run: |
          echo "::group::ðŸ§ª Running tests"

          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[1;33m'
          BLUE='\033[1;34m'
          CYAN='\033[1;36m'
          NC='\033[0m'

          total=0
          passed=0
          failed=0

          echo -e "${BLUE}Searching for tests in tests/**/*${NC}"

          while IFS= read -r testfile; do
            total=$((total+1))
            outfile="${testfile}.out"

            echo -e "${CYAN}\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
            echo -e "${CYAN}â–¶ TEST: ${testfile}${NC}"
            echo -e "${CYAN}â–¶ EXPECTED OUTPUT: ${outfile}${NC}"
            echo -e "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

            if [ ! -f "$outfile" ]; then
              echo -e "${YELLOW}âš ï¸  Missing expected output file: $outfile${NC}"
              failed=$((failed+1))
              continue
            fi

            result=$(./kawac "$testfile" 2>&1)
            diff_output=$(diff <(echo "$result") "$outfile")

            if [ $? -eq 0 ]; then
              echo -e "${GREEN}âœ” PASSED${NC}"
              passed=$((passed+1))
            else
              echo -e "${RED}âœ˜ FAILED${NC}"
              failed=$((failed+1))

              echo -e "${YELLOW}--- EXPECTED ---${NC}"
              cat "$outfile"

              echo -e "${YELLOW}--- GOT ---${NC}"
              echo "$result"

              echo -e "${RED}--- DIFF ---${NC}"
              echo "$diff_output"
            fi

          done < <(find tests -type f -name '*.kawa')

          echo -e "${BLUE}\n=============================================="
          echo -e "ðŸ“ TEST SUMMARY"
          echo -e "==============================================${NC}"
          echo -e "Total tests: $total"
          echo -e "${GREEN}Passed: $passed${NC}"
          echo -e "${RED}Failed: $failed${NC}"
          echo -e "=============================================="

          if [ $failed -gt 0 ]; then
            echo -e "${RED}âŒ Some tests failed${NC}"
            exit 1
          else
            echo -e "${GREEN}ðŸŽ‰ All tests passed!${NC}"
          fi

          echo "::endgroup::"
